<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê°•ì•„ì§€ ìš´ë™ì¥ ì§€ë„ | DogBuddy</title>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        h1 { color: #4CAF50; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        #map {
            height: 600px;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        #loading-message {
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
            color: #555;
        }
    </style>

    <script th:src="@{'https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=' + ${@environment.getProperty('external.map.naver-client-id')}}"></script>

</head>
<body onload="initMap()">

<div class="container">
    <h1>ğŸ¾ ì£¼ë³€ ê°•ì•„ì§€ ìš´ë™ì¥ ì°¾ê¸°</h1>
    <div id="loading-message">ì§€ë„ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</div>
    <div id="map"></div>
</div>

<script>
    // MSA í™˜ê²½ ì„¤ì •
    const GATEWAY_URL = 'http://localhost:8000';

    // ğŸš¨ [ì œê±°] JWT_TOKEN ë³€ìˆ˜ ì œê±°

    let map;

    /**
     * 1. Naver ì§€ë„ ê°ì²´ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤. (APIê°€ ë¡œë“œëœ í›„ ì‹¤í–‰)
     */
    function initMap() {
        // ğŸš¨ [ë³€ê²½] Naver ì§€ë„ API ì‚¬ìš©
        const initialLocation = new naver.maps.LatLng(37.5665, 126.9780); // ì„œìš¸ ì‹œì²­ ê¸°ì¤€

        map = new naver.maps.Map('map', { // 'map'ì€ div ID
            center: initialLocation,
            zoom: 12,
        });

        document.getElementById('loading-message').style.display = 'none';

        // 2. ì´ˆê¸° ìœ„ì¹˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ API í˜¸ì¶œ
        // Naver ì§€ì—­ ê²€ìƒ‰ APIëŠ” location ëŒ€ì‹  keyword ê²€ìƒ‰ì„ ì‚¬ìš©í•˜ë¯€ë¡œ,
        // locationStringì€ ì„œë¹„ìŠ¤ì—ì„œ ì ì ˆíˆ ì²˜ë¦¬ë©ë‹ˆë‹¤.
        const locationString = `${initialLocation.lat()},${initialLocation.lng()}`;
        fetchDogParks(locationString);
    }

    /**
     * 2. Gatewayë¥¼ í†µí•´ user-serviceì˜ í—¥ì‚¬ê³ ë‚  APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
     * (GET /user/dog-parks)
     */
    function fetchDogParks(locationString) {
        const url = `${GATEWAY_URL}/user/dog-parks?location=${locationString}`;

        fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                // ğŸš¨ [ì œê±°] Authorization í—¤ë” ì œê±°
            }
        })
        .then(response => {
            // ğŸš¨ [ìˆ˜ì •] í† í° ê²€ì¦ ë¡œì§ì´ Gatewayì—ì„œ ì œê±°ë˜ì—ˆìœ¼ë¯€ë¡œ,
            // 401 ì—ëŸ¬ëŠ” Gateway ë¬¸ì œê°€ ì•„ë‹ˆë¼ API í‚¤ ë¬¸ì œì¼ ê°€ëŠ¥ì„±ì´ ë†’ì•„ì§
            if (response.ok) {
                return response.json();
            }
            // ì™¸ë¶€ API í˜¸ì¶œ ì‹¤íŒ¨ (500) ë“±
            throw new Error(`API call failed with status: ${response.status}`);
        })
        .then(data => {
            // ğŸš¨ [ë³€ê²½] Naver ì§€ì—­ ê²€ìƒ‰ API ì‘ë‹µ í˜•ì‹ì— ë§ê²Œ ë°ì´í„° ì²˜ë¦¬
            if (data.items) {
                data.items.forEach(place => {
                    addMarker(place);
                });
                console.log(`ì´ ${data.items.length}ê°œì˜ ì¥ì†Œë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`);
            } else {
                console.warn("ì§€ë„ APIì—ì„œ 'items' ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.", data);
            }
        })
        .catch(error => {
            console.error('Error fetching dog parks:', error);
            alert(`ì§€ë„ ì •ë³´ ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
        });
    }

    /**
     * 3. Naver ì§€ë„ì— ë§ˆì»¤ë¥¼ ì¶”ê°€í•˜ê³  ì¸í¬ìœˆë„ìš°ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
     */
    function addMarker(place) {
        // Naver ì§€ì—­ ê²€ìƒ‰ APIëŠ” ì¢Œí‘œë¥¼ x(ê²½ë„), y(ìœ„ë„)ë¡œ ì œê³µí•˜ì§€ë§Œ,
        // ì—¬ê¸°ì„œëŠ” ì„ì‹œë¡œ ì„œìš¸ ì‹œì²­ ì¢Œí‘œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì‹¤ì œ ì¢Œí‘œ ë³€í™˜ ë¡œì§ì´ í•„ìš”í•©ë‹ˆë‹¤.
        const position = new naver.maps.LatLng(37.5665, 126.9780);

        const marker = new naver.maps.Marker({
            map: map,
            position: position,
            title: place.title,
            icon: {
                content: `<div style="padding:5px; background:white; border:1px solid #000;">${place.title}</div>`
            }
        });

        // ë§ˆì»¤ í´ë¦­ ì‹œ ì •ë³´ í‘œì‹œ
        const infoWindow = new naver.maps.InfoWindow({
            content: `
                <div>
                    <strong>${place.title}</strong>
                    <p>${place.roadAddress || place.address}</p>
                    <p>ì¹´í…Œê³ ë¦¬: ${place.category}</p>
                </div>
            `
        });

        marker.addListener('click', () => {
            infoWindow.open(map, marker);
        });
    }
</script>
</body>
</html>