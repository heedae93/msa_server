<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê°•ì•„ì§€ ìš´ë™ì¥ ì§€ë„</title>
    <style>
        #map {
            height: 600px;
            width: 100%;
        }
    </style>
    <script th:src="@{'https://maps.googleapis.com/maps/api/js?key=' + ${@environment.getProperty('external.map.api-key')}}"></script>
</head>
<body>
<h1>ğŸ¾ ì£¼ë³€ ê°•ì•„ì§€ ìš´ë™ì¥ ì°¾ê¸°</h1>
<p>í˜„ì¬ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì£¼ë³€ ìš´ë™ì¥ ì •ë³´ë¥¼ ì§€ë„ì— í‘œì‹œí•©ë‹ˆë‹¤.</p>

<div id="map"></div>

<script>
    // API Gateway ì£¼ì†Œ (í˜„ì¬ í™˜ê²½ì—ì„œëŠ” localhost:8000)
    const GATEWAY_URL = 'http://localhost:8000';

    // ğŸš¨ ì„ì‹œ í† í° ì„¤ì • (ìˆ˜ë™ìœ¼ë¡œ íšë“í•œ ìœ íš¨í•œ JWT í† í°ìœ¼ë¡œ êµì²´í•´ì•¼ í•©ë‹ˆë‹¤!)
    const DUMMY_JWT_TOKEN = 'ì—¬ê¸°ì—_ìœ íš¨í•œ_JWT_í† í°ì„_ìˆ˜ë™ìœ¼ë¡œ_ë„£ì–´ì£¼ì„¸ìš”';

    // ì§€ë„ ê°ì²´
    let map;

    function initMap() {
        // ì§€ë„ ì´ˆê¸° ìœ„ì¹˜: ì„œìš¸ (ì˜ˆì‹œ)
        const initialLocation = { lat: 37.5665, lng: 126.9780 };

        map = new google.maps.Map(document.getElementById('map'), {
            center: initialLocation,
            zoom: 12,
        });

        // ì´ˆê¸° ìœ„ì¹˜ì˜ ìœ„ë„, ê²½ë„ë¥¼ API ìš”ì²­ì— ì‚¬ìš©
        const locationString = `${initialLocation.lat},${initialLocation.lng}`;
        fetchDogParks(locationString);
    }

    function fetchDogParks(locationString) {
        const url = `${GATEWAY_URL}/user/dog-parks?location=${locationString}`;

        fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                // ğŸš¨ Gateway JWT í•„í„°ê°€ ìš”êµ¬í•˜ëŠ” í† í°ì„ ì „ì†¡í•©ë‹ˆë‹¤.
                'Authorization': `Bearer ${DUMMY_JWT_TOKEN}`
            }
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else if (response.status === 401) {
                alert('ì¸ì¦ ì‹¤íŒ¨! JWT í† í°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                throw new Error('Unauthorized');
            } else {
                alert('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨');
                throw new Error('Failed to load data');
            }
        })
        .then(data => {
            if (data.results) {
                data.results.forEach(place => {
                    addMarker(place);
                });
            }
        })
        .catch(error => console.error('Error:', error));
    }

    function addMarker(place) {
        const position = {
            lat: place.geometry.location.lat,
            lng: place.geometry.location.lng
        };

        new google.maps.Marker({
            map: map,
            position: position,
            title: place.name
        });
    }

    // ğŸš¨ ì§€ë„ê°€ ë¡œë“œë˜ë©´ initMap í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë„ë¡ ì„¤ì •
    window.initMap = initMap;
</script>
</body>
</html>